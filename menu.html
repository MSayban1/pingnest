<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Ping Nest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .site-name {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .online-users {
            color: #666;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 2rem;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }

        .chat-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .chat-option {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .chat-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .option-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .option-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .option-description {
            color: #666;
            line-height: 1.6;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .popup-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .popup-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input:disabled {
            background: #f0f0f0;
            color: #666;
        }

        .popup-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .error {
            color: #e74c3c;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 2rem 1rem;
            }
            
            .chat-options {
                grid-template-columns: 1fr;
            }
            
            .site-name {
                font-size: 2rem;
            }
            
            .welcome-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="site-name">Ping Nest</h1>
        <div class="online-users">
            <div class="online-indicator"></div>
            <span id="onlineCount">Loading...</span> users online
        </div>
    </header>

    <div class="container">
        <section class="welcome-section">
            <h1 class="welcome-title">Welcome Back!</h1>
            <div class="user-info">
                <div class="user-details">
                    <span id="userFlag">üåç</span>
                    <span id="userName">User</span>
                    <span>‚Ä¢</span>
                    <span id="userCountry">Country</span>
                </div>
            </div>
        </section>

        <section class="chat-options">
            <div class="chat-option" onclick="goToInternationalChat()">
                <div class="option-icon">üåç</div>
                <h3 class="option-title">International Chat</h3>
                <p class="option-description">Join the global conversation with users from around the world</p>
            </div>

            <div class="chat-option" onclick="showCreateRoomPopup()">
                <div class="option-icon">üè†</div>
                <h3 class="option-title">Create Chat Room</h3>
                <p class="option-description">Create your own private chat room with custom ID and password</p>
            </div>

            <div class="chat-option" onclick="showJoinRoomPopup()">
                <div class="option-icon">üîë</div>
                <h3 class="option-title">Join Chat Room</h3>
                <p class="option-description">Join an existing private chat room using Room ID and Key</p>
            </div>

            <div class="chat-option" onclick="showCreateGroupPopup()">
                <div class="option-icon">üë•</div>
                <h3 class="option-title">Create Group</h3>
                <p class="option-description">Create a group chat for multiple users with admin controls</p>
            </div>

            <div class="chat-option" onclick="showJoinGroupPopup()">
                <div class="option-icon">üö™</div>
                <h3 class="option-title">Join Group</h3>
                <p class="option-description">Join an existing group using Group ID and Key</p>
            </div>
        </section>
    </div>

    <!-- Popups -->
    <div id="createRoomPopup" class="popup-overlay">
        <div class="popup">
            <button class="popup-close" onclick="closePopup('createRoomPopup')">&times;</button>
            <h2 class="popup-title">Create Chat Room</h2>
            <form id="createRoomForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="roomCreatorName" class="form-input" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Room ID (6 digits only)</label>
                    <input type="text" id="roomId" class="form-input" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required>
                    <div id="roomIdError" class="error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Room Key (7 digits only)</label>
                    <input type="text" id="roomKey" class="form-input" placeholder="1234567" maxlength="7" pattern="[0-9]{7}" required>
                    <div id="roomKeyError" class="error"></div>
                </div>
                <button type="submit" class="popup-btn">Create Room</button>
            </form>
        </div>
    </div>

    <div id="joinRoomPopup" class="popup-overlay">
        <div class="popup">
            <button class="popup-close" onclick="closePopup('joinRoomPopup')">&times;</button>
            <h2 class="popup-title">Join Chat Room</h2>
            <form id="joinRoomForm">
                <div class="form-group">
                    <label class="form-label">Room ID</label>
                    <input type="text" id="joinRoomId" class="form-input" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required>
                    <div id="joinRoomIdError" class="error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Room Key</label>
                    <input type="text" id="joinRoomKey" class="form-input" placeholder="1234567" maxlength="7" pattern="[0-9]{7}" required>
                    <div id="joinRoomKeyError" class="error"></div>
                </div>
                <button type="submit" class="popup-btn">Join Room</button>
            </form>
        </div>
    </div>

    <div id="createGroupPopup" class="popup-overlay">
        <div class="popup">
            <button class="popup-close" onclick="closePopup('createGroupPopup')">&times;</button>
            <h2 class="popup-title">Create Group</h2>
            <form id="createGroupForm">
                <div class="form-group">
                    <label class="form-label">Group ID (6 digits only)</label>
                    <input type="text" id="groupId" class="form-input" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required>
                    <div id="groupIdError" class="error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Group Key (7 digits only)</label>
                    <input type="text" id="groupKey" class="form-input" placeholder="1234567" maxlength="7" pattern="[0-9]{7}" required>
                    <div id="groupKeyError" class="error"></div>
                </div>
                <button type="submit" class="popup-btn">Create Group</button>
            </form>
        </div>
    </div>

    <div id="joinGroupPopup" class="popup-overlay">
        <div class="popup">
            <button class="popup-close" onclick="closePopup('joinGroupPopup')">&times;</button>
            <h2 class="popup-title">Join Group</h2>
            <form id="joinGroupForm">
                <div class="form-group">
                    <label class="form-label">Group ID</label>
                    <input type="text" id="joinGroupId" class="form-input" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required>
                    <div id="joinGroupIdError" class="error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Group Key</label>
                    <input type="text" id="joinGroupKey" class="form-input" placeholder="1234567" maxlength="7" pattern="[0-9]{7}" required>
                    <div id="joinGroupKeyError" class="error"></div>
                </div>
                <button type="submit" class="popup-btn">Join Group</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports and configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAN_Fmk_Y6fNPnnPYlnFHAkttw-SioWzmU",
            authDomain: "world-chat-f42a9.firebaseapp.com",
            databaseURL: "https://world-chat-f42a9-default-rtdb.firebaseio.com",
            projectId: "world-chat-f42a9",
            storageBucket: "world-chat-f42a9.firebasestorage.app",
            messagingSenderId: "1086213718761",
            appId: "1:1086213718761:web:829f1691b2b61cad9ba678",
            measurementId: "G-GV1HSDP8XW"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let currentUser = null;

        // Country flags mapping
        const countryFlags = {
            'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'DE': 'üá©üá™',
            'FR': 'üá´üá∑', 'IT': 'üáÆüáπ', 'ES': 'üá™üá∏', 'NL': 'üá≥üá±', 'BE': 'üáßüá™',
            'CH': 'üá®üá≠', 'AT': 'üá¶üáπ', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥', 'DK': 'üá©üá∞',
            'FI': 'üá´üáÆ', 'PL': 'üáµüá±', 'CZ': 'üá®üáø', 'HU': 'üá≠üá∫', 'SK': 'üá∏üá∞',
            'SI': 'üá∏üáÆ', 'HR': 'üá≠üá∑', 'RS': 'üá∑üá∏', 'BG': 'üáßüá¨', 'RO': 'üá∑üá¥',
            'GR': 'üá¨üá∑', 'TR': 'üáπüá∑', 'RU': 'üá∑üá∫', 'UA': 'üá∫üá¶', 'BY': 'üáßüáæ',
            'LT': 'üá±üáπ', 'LV': 'üá±üáª', 'EE': 'üá™üá™', 'JP': 'üáØüáµ', 'KR': 'üá∞üá∑',
            'CN': 'üá®üá≥', 'IN': 'üáÆüá≥', 'ID': 'üáÆüá©', 'TH': 'üáπüá≠', 'VN': 'üáªüá≥',
            'PH': 'üáµüá≠', 'MY': 'üá≤üáæ', 'SG': 'üá∏üá¨', 'BR': 'üáßüá∑', 'AR': 'üá¶üá∑',
            'MX': 'üá≤üáΩ', 'CL': 'üá®üá±', 'CO': 'üá®üá¥', 'PE': 'üáµüá™', 'VE': 'üáªüá™',
            'ZA': 'üáøüá¶', 'EG': 'üá™üá¨', 'NG': 'üá≥üá¨', 'KE': 'üá∞üá™', 'MA': 'üá≤üá¶',
            'IL': 'üáÆüá±', 'SA': 'üá∏üá¶', 'AE': 'üá¶üá™', 'IR': 'üáÆüá∑', 'IQ': 'üáÆüá∂',
            'PK': 'üáµüá∞', 'BD': 'üáßüá©', 'LK': 'üá±üá∞', 'NP': 'üá≥üáµ', 'AF': 'üá¶üá´'
        };

        // Initialize user data
        function initializeUser() {
            const userData = localStorage.getItem('pingNestUser');
            if (!userData) {
                window.location.href = 'auth.html';
                return;
            }

            currentUser = JSON.parse(userData);
            
            // Update user display
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userCountry').textContent = currentUser.country;
            document.getElementById('userFlag').textContent = countryFlags[currentUser.countryCode] || 'üåç';
            document.getElementById('roomCreatorName').value = currentUser.username;

            // Update user's online status
            updateUserOnlineStatus();
        }

        // Update user online status
        async function updateUserOnlineStatus() {
            try {
                await update(ref(database, `users/${currentUser.id}`), {
                    isOnline: true,
                    lastSeen: Date.now()
                });
            } catch (error) {
                console.error('Error updating online status:', error);
            }
        }

        // Track online users
        function trackOnlineUsers() {
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    const onlineUsers = Object.values(users).filter(user => 
                        user.isOnline && (Date.now() - user.lastSeen < 300000) // 5 minutes
                    );
                    document.getElementById('onlineCount').textContent = onlineUsers.length;
                } else {
                    document.getElementById('onlineCount').textContent = '0';
                }
            });
        }

        // Show loader function
        function showLoader() {
            document.body.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    gap: 40px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    z-index: 9999;
                ">
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 20px;
                        margin-bottom: 20px;
                    ">
                        <div style="
                            width: 60px;
                            height: 50px;
                            --m: no-repeat linear-gradient(90deg, #000 70%, #0000 0);
                            -webkit-mask: 
                                var(--m) calc(0*100%/4) 100%/calc(100%/5) calc(1*100%/5),
                                var(--m) calc(1*100%/4) 100%/calc(100%/5) calc(2*100%/5),
                                var(--m) calc(2*100%/4) 100%/calc(100%/5) calc(3*100%/5),
                                var(--m) calc(3*100%/4) 100%/calc(100%/5) calc(4*100%/5),
                                var(--m) calc(4*100%/4) 100%/calc(100%/5) calc(5*100%/5);
                            background: linear-gradient(#3498db 0 0) left/0% 100% no-repeat #e0e0e0;
                            animation: l14 2s infinite steps(6);
                        "></div>
                        <div style="
                            height: 20px;
                            position: relative;
                            width: 140px;
                            text-align: center;
                        ">
                            <div style="
                                position: absolute;
                                left: 0;
                                right: 0;
                                opacity: 0;
                                font-family: Arial, sans-serif;
                                font-size: 14px;
                                color: white;
                                animation: wordFade 3.6s infinite;
                                transform: translateY(5px);
                                animation-delay: 0s;
                            ">Connecting...</div>
                            <div style="
                                position: absolute;
                                left: 0;
                                right: 0;
                                opacity: 0;
                                font-family: Arial, sans-serif;
                                font-size: 14px;
                                color: white;
                                animation: wordFade 3.6s infinite;
                                transform: translateY(5px);
                                animation-delay: 1.2s;
                            ">Loading...</div>
                            <div style="
                                position: absolute;
                                left: 0;
                                right: 0;
                                opacity: 0;
                                font-family: Arial, sans-serif;
                                font-size: 14px;
                                color: white;
                                animation: wordFade 3.6s infinite;
                                transform: translateY(5px);
                                animation-delay: 2.4s;
                            ">Please wait...</div>
                        </div>
                    </div>
                    <div style="
                        position: absolute;
                        bottom: 40px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 8px;
                    ">
                        <img src="https://i.postimg.cc/vcbWpYgn/file-0000000038e461f5a640567745c91ec2.png" alt="Ping Nest" style="
                            width: 30px;
                            height: 30px;
                        ">
                        <div style="
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                            color: rgba(255, 255, 255, 0.8);
                            letter-spacing: 0.5px;
                        ">Ping Nest</div>
                    </div>
                </div>
                <style>
                    @keyframes l14 {
                        100% { background-size: 120% 100%; }
                    }
                    @keyframes wordFade {
                        0%, 20% { opacity: 0; transform: translateY(5px); }
                        30%, 70% { opacity: 1; transform: translateY(0); }
                        80%, 100% { opacity: 0; transform: translateY(-5px); }
                    }
                </style>
            `;
        }

        // Global functions for navigation and popups
        window.goToInternationalChat = function() {
            showLoader();
            setTimeout(() => {
                window.location.href = 'international-chat.html';
            }, 6000);
        };

        window.showCreateRoomPopup = function() {
            document.getElementById('createRoomPopup').style.display = 'flex';
        };

        window.showJoinRoomPopup = function() {
            document.getElementById('joinRoomPopup').style.display = 'flex';
        };

        window.showCreateGroupPopup = function() {
            document.getElementById('createGroupPopup').style.display = 'flex';
        };

        window.showJoinGroupPopup = function() {
            document.getElementById('joinGroupPopup').style.display = 'flex';
        };

        window.closePopup = function(popupId) {
            document.getElementById(popupId).style.display = 'none';
            // Clear form errors
            const errorElements = document.querySelectorAll('.error');
            errorElements.forEach(el => el.textContent = '');
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeUser();
            trackOnlineUsers();

            // Create Room Form
            document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const roomId = document.getElementById('roomId').value;
                const roomKey = document.getElementById('roomKey').value;
                
                if (!/^\d{6}$/.test(roomId)) {
                    document.getElementById('roomIdError').textContent = 'Room ID must be exactly 6 digits';
                    return;
                }
                
                if (!/^\d{7}$/.test(roomKey)) {
                    document.getElementById('roomKeyError').textContent = 'Room Key must be exactly 7 digits';
                    return;
                }

                try {
                    const roomSnapshot = await get(ref(database, `rooms/${roomId}`));
                    if (roomSnapshot.exists()) {
                        document.getElementById('roomIdError').textContent = 'Room ID already exists';
                        return;
                    }

                    const roomData = {
                        id: roomId,
                        key: roomKey,
                        creator: currentUser.id,
                        creatorName: currentUser.username,
                        createdAt: Date.now(),
                        members: {
                            [currentUser.id]: {
                                username: currentUser.username,
                                country: currentUser.country,
                                countryCode: currentUser.countryCode,
                                joinedAt: Date.now(),
                                isOnline: true
                            }
                        }
                    };

                    await set(ref(database, `rooms/${roomId}`), roomData);
                    
                    localStorage.setItem('currentRoom', JSON.stringify({
                        id: roomId,
                        key: roomKey,
                        isCreator: true
                    }));

                    showLoader();
                    setTimeout(() => {
                        window.location.href = 'private-room.html';
                    }, 6000);

                } catch (error) {
                    console.error('Error creating room:', error);
                    alert('Error creating room. Please try again.');
                }
            });

            // Join Room Form
            document.getElementById('joinRoomForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const roomId = document.getElementById('joinRoomId').value;
                const roomKey = document.getElementById('joinRoomKey').value;
                
                if (!/^\d{6}$/.test(roomId)) {
                    document.getElementById('joinRoomIdError').textContent = 'Room ID must be exactly 6 digits';
                    return;
                }
                
                if (!/^\d{7}$/.test(roomKey)) {
                    document.getElementById('joinRoomKeyError').textContent = 'Room Key must be exactly 7 digits';
                    return;
                }

                try {
                    const roomSnapshot = await get(ref(database, `rooms/${roomId}`));
                    if (!roomSnapshot.exists()) {
                        document.getElementById('joinRoomIdError').textContent = 'Room does not exist';
                        return;
                    }

                    const roomData = roomSnapshot.val();
                    if (roomData.key !== roomKey) {
                        document.getElementById('joinRoomKeyError').textContent = 'Invalid room key';
                        return;
                    }

                    await update(ref(database, `rooms/${roomId}/members/${currentUser.id}`), {
                        username: currentUser.username,
                        country: currentUser.country,
                        countryCode: currentUser.countryCode,
                        joinedAt: Date.now(),
                        isOnline: true
                    });
                    
                    localStorage.setItem('currentRoom', JSON.stringify({
                        id: roomId,
                        key: roomKey,
                        isCreator: false
                    }));

                    showLoader();
                    setTimeout(() => {
                        window.location.href = 'private-room.html';
                    }, 6000);

                } catch (error) {
                    console.error('Error joining room:', error);
                    alert('Error joining room. Please try again.');
                }
            });

            // Create Group Form
            document.getElementById('createGroupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const groupId = document.getElementById('groupId').value;
                const groupKey = document.getElementById('groupKey').value;
                
                if (!/^\d{6}$/.test(groupId)) {
                    document.getElementById('groupIdError').textContent = 'Group ID must be exactly 6 digits';
                    return;
                }
                
                if (!/^\d{7}$/.test(groupKey)) {
                    document.getElementById('groupKeyError').textContent = 'Group Key must be exactly 7 digits';
                    return;
                }

                try {
                    const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                    if (groupSnapshot.exists()) {
                        document.getElementById('groupIdError').textContent = 'Group ID already exists';
                        return;
                    }

                    const groupData = {
                        id: groupId,
                        key: groupKey,
                        admin: currentUser.id,
                        adminName: currentUser.username,
                        createdAt: Date.now(),
                        members: {
                            [currentUser.id]: {
                                username: currentUser.username,
                                country: currentUser.country,
                                countryCode: currentUser.countryCode,
                                joinedAt: Date.now(),
                                isOnline: true,
                                isAdmin: true
                            }
                        }
                    };

                    await set(ref(database, `groups/${groupId}`), groupData);
                    
                    localStorage.setItem('currentGroup', JSON.stringify({
                        id: groupId,
                        key: groupKey,
                        isAdmin: true
                    }));

                    showLoader();
                    setTimeout(() => {
                        window.location.href = 'group-chat.html';
                    }, 6000);

                } catch (error) {
                    console.error('Error creating group:', error);
                    alert('Error creating group. Please try again.');
                }
            });

            // Join Group Form
            document.getElementById('joinGroupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const groupId = document.getElementById('joinGroupId').value;
                const groupKey = document.getElementById('joinGroupKey').value;
                
                if (!/^\d{6}$/.test(groupId)) {
                    document.getElementById('joinGroupIdError').textContent = 'Group ID must be exactly 6 digits';
                    return;
                }
                
                if (!/^\d{7}$/.test(groupKey)) {
                    document.getElementById('joinGroupKeyError').textContent = 'Group Key must be exactly 7 digits';
                    return;
                }

                try {
                    const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                    if (!groupSnapshot.exists()) {
                        document.getElementById('joinGroupIdError').textContent = 'Group does not exist';
                        return;
                    }

                    const groupData = groupSnapshot.val();
                    if (groupData.key !== groupKey) {
                        document.getElementById('joinGroupKeyError').textContent = 'Invalid group key';
                        return;
                    }

                    await update(ref(database, `groups/${groupId}/members/${currentUser.id}`), {
                        username: currentUser.username,
                        country: currentUser.country,
                        countryCode: currentUser.countryCode,
                        joinedAt: Date.now(),
                        isOnline: true,
                        isAdmin: false
                    });
                    
                    localStorage.setItem('currentGroup', JSON.stringify({
                        id: groupId,
                        key: groupKey,
                        isAdmin: false
                    }));

                    showLoader();
                    setTimeout(() => {
                        window.location.href = 'group-chat.html';
                    }, 6000);

                } catch (error) {
                    console.error('Error joining group:', error);
                    alert('Error joining group. Please try again.');
                }
            });

            // Handle user leaving page
            window.addEventListener('beforeunload', async () => {
                if (currentUser) {
                    await update(ref(database, `users/${currentUser.id}`), {
                        isOnline: false,
                        lastSeen: Date.now()
                    });
                }
            });
        });
    </script>
</body>
</html>
